# event_recommendation
<div id="article_content" class="article_content csdn-tracking-statistics" data-pid="blog" data-mod="popu_307" data-dsm="post">
                    <link rel="stylesheet" href="https://csdnimg.cn/release/phoenix/template/css/htmledit_views-0a60691e80.css">
            <div class="htmledit_views">
                
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
这个案例跟推荐系统相关，预测用户可能感兴趣的event。关于这个案例更多信息打开<a target="_blank" href="https://www.kaggle.com/c/event-recommendation-engine-challenge/data" style="color:rgb(12,137,207)">event_recommendation_competition</a>。这里我直接讲解第一名的解决方案。<span style="">这个方案中除了包含经典的机器学习解决步骤，还融合了推荐系统里传统的解决方法：基于用户的协同过滤，基于物品的协同过滤，当然也可以融合LFM模型等等</span>，因为这个解决方案很经典，所以我觉得值得拿出来详细讲讲。我将贴出完整代码，并且进行很详细的讲解。</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
首先看看比赛给的数据：train,test,users,events,user_friends,attendees这六张表。详细的数据描述请打开上面链接查看。</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<div style="color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px"><br style="">
train表：&nbsp;<br style="">
<img src="https://img-blog.csdn.net/20170625155906871?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:100%; max-height:100%"></div>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<div style="color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px"><br style="">
test表：&nbsp;<br style="">
<img src="https://img-blog.csdn.net/20170625160055065?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:100%; max-height:100%"></div>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<div style="color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px"><br style="">
users表：&nbsp;<br style="">
<img src="https://img-blog.csdn.net/20170625160144218?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:100%; max-height:100%"></div>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<div style="color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px"><br style="">
events表：&nbsp;<br style="">
<img src="https://img-blog.csdn.net/20170625163443411?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:100%; max-height:100%"></div>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<div style="color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px"><br style="">
event_attendees表：&nbsp;<br style="">
<img src="https://img-blog.csdn.net/20170625160233499?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:100%; max-height:100%"></div>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<div style="color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px"><br style="">
user_friends表：&nbsp;<br style="">
<img src="https://img-blog.csdn.net/20170625160356532?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:100%; max-height:100%"></div>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
</p>
<ul style="line-height:27.2px; margin-bottom:1.7em; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<li style="">首先这是一个 推荐 的问题</li><li style="">
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px">
我们有下面这样几类数据&nbsp;<br style="">
①：用户的历史数据 =&gt; 对 event 是否感兴趣/是否参加&nbsp;<br style="">
②：用户社交数据 =&gt; 朋友圈&nbsp;<br style="">
③：event 相关的数据 =&gt; event</p>
</li><li style="">
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px">
简单思考&nbsp;<br style="">
①：要把更多维度的信息纳入考量。&nbsp;<br style="">
②：协同过滤是基于user -event 历史交互数据。&nbsp;<br style="">
③：需要把社交数据和event 相关信息 作为影响最后结果的因素纳入考量。&nbsp;<br style="">
④：视作分类模型，每一个人感兴趣/不感兴趣 是 target，其他影响结果的是feature。&nbsp;<br style="">
⑤：<span style="">影响结果的 feature 包括由协同过滤产出的推荐度</span>。（userCF，itemCF）</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px">
<span style="">第一名的解决方案思路：</span></p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px">
<img src="https://img-blog.csdn.net/20170625162135884?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:602px; max-height:100%; height:auto">&nbsp;<br style="">
因为数据很大，用pandas读取数据，内存可能吃不下，所以我们用scipy.sparse里面稀疏矩阵dok_matrix来一行一行的存储数据。&nbsp;<br style="">
<span style="">下面边看代码边讲解：</span></p>
</li></ul>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> __future__ <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> division

<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> itertools
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> cPickle
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> datetime
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> hashlib
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> locale
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> numpy <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> np
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> pycountry
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> scipy.io <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> sio
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> scipy.sparse <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> ss
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> scipy.spatial.distance <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> ssd

<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> collections <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> defaultdict
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> sklearn.preprocessing <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> normalize</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
1.数据清洗类&nbsp;<br style="">
这个类主要做一些数据预处理的事情，例如对user性别进行0,1化；对locale进行编号；将字符串型的日期转成date型；等等。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">DataCleaner</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  Common utilities for converting strings to equivalent numbers
  or number buckets.
  """</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">__init__</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self)</span>:</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 载入 locales</span>
    self.localeIdMap = defaultdict(int)<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##defaultdict给所有key赋予默认的value（int型为0）</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i, l <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> enumerate(locale.locale_alias.keys()):
      self.localeIdMap[l] = i + <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 载入 countries</span>
    self.countryIdMap = defaultdict(int)
    ctryIdx = defaultdict(int)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i, c <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> enumerate(pycountry.countries):
      self.countryIdMap[c.name.lower()] = i + <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> c.name.lower() == <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"usa"</span>:
        ctryIdx[<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"US"</span>] = i
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> c.name.lower() == <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"canada"</span>:
        ctryIdx[<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"CA"</span>] = i
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> cc <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> ctryIdx.keys():
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> s <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> pycountry.subdivisions.get(country_code=cc):
        self.countryIdMap[s.name.lower()] = ctryIdx[cc] + <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 载入 gender id 字典</span>
    self.genderIdMap = defaultdict(int, {<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"male"</span>:<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"female"</span>:<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>})

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getLocaleId</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, locstr)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> self.localeIdMap[locstr.lower()]

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getGenderId</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, genderStr)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> self.genderIdMap[genderStr]

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getJoinedYearMonth</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, dateString)</span>:</span>
    dttm = datetime.datetime.strptime(dateString, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"%Y-%m-%dT%H:%M:%S.%fZ"</span>)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">""</span>.join([str(dttm.year), str(dttm.month)])

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getCountryId</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, location)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> (isinstance(location, str)
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">and</span> len(location.strip()) &gt; <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">and</span> location.rfind(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"  "</span>) &gt; -<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>):
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> self.countryIdMap[location[location.rindex(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"  "</span>) + <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>:].lower()]
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">else</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getBirthYearInt</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, birthYear)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">try</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> birthYear == <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"None"</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">else</span> int(birthYear)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">except</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getTimezoneInt</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, timezone)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">try</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> int(timezone)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">except</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getFeatureHash</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, value)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> len(value.strip()) == <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> -<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">else</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> int(hashlib.sha224(value).hexdigest()[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>:<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>], <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">16</span>)

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">getFloatValue</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, value)</span>:</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> len(value.strip()) == <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0.0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">else</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> float(value)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">40</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">41</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">42</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">43</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">44</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">45</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">46</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">47</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">48</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">49</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">50</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">51</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">52</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">53</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">54</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">55</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">56</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">57</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">58</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">59</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">60</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">61</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">62</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">63</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">64</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">65</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">66</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">2.处理user和event关联数据</span>&nbsp;<br style="">
这个类主要用来统计以下几个数据：&nbsp;<br style="">
①：uniqueUsers :set(),统计train和test中不同的user。&nbsp;<br style="">
②：uniqueEvents :set(),统计train和test中不同的event。&nbsp;<br style="">
③：eventsForUser :{event:set(users)},统计train和test中各个event有多少个不同user对其有交互。&nbsp;<br style="">
④：usersForEvent:{user:set(events)},统计train,test中各个user对多少个不同的event产生交互。&nbsp;<br style="">
⑤：userEventScores :dok_matrix形式，统计train中各个user对各个event感兴趣程度。shape[len(uniqueUsers ,uniqueEvents )]&nbsp;<br style="">
⑥：uniqueUserPairs :set(),train,test中对同一个event感兴趣的users的两两组合。&nbsp;<br style="">
⑦：uniqueEventPairs ：set(),train,test中被同一个user感兴趣的events两两组合。&nbsp;<br style="">
⑧：userIndex：dict(),{user,i},uniqueUsers 中的user与其对应的序号。&nbsp;<br style="">
⑨：eventIndex：dict(),{event,i},uniqueEvents中的event与其对应的序号。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">ProgramEntities</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  我们只关心train和test中出现的user和event，因此重点处理这部分关联数据
  """</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">__init__</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self)</span>:</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 统计训练集中有多少独立的用户的events</span>
    uniqueUsers = set()<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##统计users</span>
    uniqueEvents = set()<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##统计events</span>
    eventsForUser = defaultdict(set) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##统计{event:set(users)}</span>
    usersForEvent = defaultdict(set) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##统计{user:set(events)}</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> filename <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> [<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"train.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"test.csv"</span>]:
      f = open(filename, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
      f.readline().strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> f:
        cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
        uniqueUsers.add(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>])
        uniqueEvents.add(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>])
        eventsForUser[cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]].add(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>])
        usersForEvent[cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]].add(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>])
      f.close()
    self.userEventScores = ss.dok_matrix((len(uniqueUsers), len(uniqueEvents))) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##统计各个user对各个event感兴趣程度</span>
    self.userIndex = dict()
    self.eventIndex = dict()
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i, u <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> enumerate(uniqueUsers):
      self.userIndex[u] = i
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i, e <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> enumerate(uniqueEvents):
      self.eventIndex[e] = i
    ftrain = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"train.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
    ftrain.readline()
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> ftrain:
      cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      i = self.userIndex[cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]]
      j = self.eventIndex[cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]]
      self.userEventScores[i, j] = int(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>]) - int(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">5</span>])<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##统计train中各个user对各个event感兴趣程度;cols[4]为interest列;cols[5]为not interested列</span>
    ftrain.close()
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"PE_userEventScores"</span>, self.userEventScores)
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 为了防止不必要的计算，我们找出来所有关联的user 或者 关联的event</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 所谓的关联用户，指的是至少在同一个event上有行为的用户pair</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 关联的event指的是至少同一个user有行为的event pair</span>
    self.uniqueUserPairs = set()
    self.uniqueEventPairs = set()
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> event <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> uniqueEvents:
      users = usersForEvent[event]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> len(users) &gt; <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>:
        self.uniqueUserPairs.update(itertools.combinations(users, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>))<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##itertools.combinations(users, 2)表示在users中随机抽取两个不同的user进行组合，然后更新到uniqueUserPairs。</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> user <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> uniqueUsers:
      events = eventsForUser[user]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> len(events) &gt; <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>:
        self.uniqueEventPairs.update(itertools.combinations(events, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>))
    cPickle.dump(self.userIndex, open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"PE_userIndex.pkl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'wb'</span>))
    cPickle.dump(self.eventIndex, open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"PE_eventIndex.pkl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'wb'</span>))</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">40</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">41</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">42</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">43</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">44</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">45</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">46</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">47</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">48</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">49</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">50</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">51</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">3.用户与用户相似度矩阵</span>&nbsp;<br style="">
这个类主要统计以下几个数据：&nbsp;<br style="">
①userMatrix :dok_matrix形式，根据users表，shape[len(users),len(users.columns)-1],除去users表中的user_id列，将表中其他列数据放进这个矩阵。就是统计userIndex表中各个user在users表中的属性。&nbsp;<br style="">
②userSimMatrix ：dok_matrix形式，shape[len(users),len(users)],根据userMatrix矩阵中用户属性数据，利用scipy.spatial.distance.correlation(欧式距离）来计算uniqueUserPairs中每两个user（<span style="">这两个user对至少对同一个events发生过行为</span>）相似度，从而得出用户相似度矩阵。这种相似度计算类似于协同过滤里相似度。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs ruby has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">Users</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">""</span><span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"
  构建 user/user 相似度矩阵
  "</span><span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">""</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> </span>__init_<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">_</span>(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>, programEntities, sim=ssd.correlation)<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
    cleaner = <span class="hljs-constant" style="box-sizing: border-box;">DataCleaner</span>()
    nusers = len(programEntities.userIndex.keys())
    fin = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"users.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
    colnames = fin.readline().strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix = ss.dok_matrix((nusers, len(colnames) - <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>))
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> <span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">fin:</span>
      cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 只考虑train.csv中出现的用户</span>
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> programEntities.userIndex.has_key(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>])<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
        i = programEntities.userIndex[cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]]
        <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">##将数据进行预处理再放进userMatrix矩阵中</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] = cleaner.getLocaleId(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>])
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] = cleaner.getBirthYearInt(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>])
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>] = cleaner.getGenderId(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">3</span>])
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">3</span>] = cleaner.getJoinedYearMonth(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>])
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>] = cleaner.getCountryId(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">5</span>])
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">5</span>] = cleaner.getTimezoneInt(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">6</span>])
    fin.close()
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 归一化用户矩阵</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix = normalize(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix, norm=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l1"</span>, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, copy=<span class="hljs-constant" style="box-sizing: border-box;">False</span>)
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"US_userMatrix"</span>, <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix)
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 计算用户相似度矩阵，之后会用到</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userSimMatrix = ss.dok_matrix((nusers, nusers))
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> range(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, nusers)<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userSimMatrix[i, i] = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1.0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> u1, u2 <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> programEntities.<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">uniqueUserPairs:</span>
      i = programEntities.userIndex[u1]
      j = programEntities.userIndex[u2]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">not</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userSimMatrix.has_key((i, j))<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
        usim = sim(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix.getrow(i).todense(),
          <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userMatrix.getrow(j).todense())
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userSimMatrix[i, j] = usim
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userSimMatrix[j, i] = usim
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"US_userSimMatrix"</span>, <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.userSimMatrix)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">4.用户社交关系挖掘</span>&nbsp;<br style="">
这个类分析用户社交信息，统计以下几个数据：&nbsp;<br style="">
①：numFriends ：矩阵，shape[1,len(users)],统计userIndex表中每个user有多少个friends。如果用户朋友很多在一定程度上说明用户性格外向。&nbsp;<br style="">
②：userFriends ：dok_matrix,shape[len(users),len(users)],统计第i个user的第j个朋友的活跃程度。如果用户的朋友都很活跃能在一定程度上说明用户也很活跃。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">UserFriends</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  找出某用户的那些朋友，想法非常简单
  1)如果你有更多的朋友，可能你性格外向，更容易参加各种活动
  2)如果你朋友会参加某个活动，可能你也会跟随去参加一下
  """</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">__init__</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, programEntities)</span>:</span>
    nusers = len(programEntities.userIndex.keys())
    self.numFriends = np.zeros((nusers))
    self.userFriends = ss.dok_matrix((nusers, nusers))
    fin = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_friends.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
    fin.readline()                <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># skip header</span>
    ln = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> fin:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> ln % <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">200</span> == <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>:
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"Loading line: "</span>, ln
      cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      user = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> programEntities.userIndex.has_key(user):
        friends = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>].split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">" "</span>)
        i = programEntities.userIndex[user]
        self.numFriends[i] = len(friends)
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> friend <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> friends:
          <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> programEntities.userIndex.has_key(friend):
            j = programEntities.userIndex[friend]
            <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># the objective of this score is to infer the degree to</span>
            <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># and direction in which this friend will influence the</span>
            <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># user's decision, so we sum the user/event score for</span>
            <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># this user across all training events.</span>
            eventsForUser = programEntities.userEventScores.getrow(j).todense()
            score = eventsForUser.sum() / np.shape(eventsForUser)[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]
            self.userFriends[i, j] += score
            self.userFriends[j, i] += score
      ln += <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
    fin.close()
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 归一化数组</span>
    sumNumFriends = self.numFriends.sum(axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>)
    self.numFriends = self.numFriends / sumNumFriends
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"UF_numFriends"</span>, np.matrix(self.numFriends))
    self.userFriends = normalize(self.userFriends, norm=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l1"</span>, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, copy=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">False</span>)
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"UF_userFriends"</span>, self.userFriends)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">40</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">41</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">5.构造event和event相似度数据</span>&nbsp;<br style="">
<span style="">构建event-event相似度，注意这里有2种相似度：</span>&nbsp;<br style="">
①eventPropMatrix ：dok_matrix形式，shape[len(events),7]，查看events表会发现，有109列，其中前9列是<span style="">event与user历史交互信息</span>，除去event_id,user_id两列，将剩余的每列数据放进eventPropMatrix 矩阵中。&nbsp;<br style="">
②eventContMatrix:dok_matrix形式，shape[len(events),100]，events表中剩余的100列表示event本身内容信息，其中count_N是表示第N个最常见词干在该事件的名称或描述中出现的次数的整数。 count_other是其余词的计数。将events中剩余的9-109列数据放进该矩阵中 。&nbsp;<br style="">
③eventPropSim: dok_matrix形式，shape[len(events),len(events)]，event相似度矩阵，根据eventPropMatrix 矩阵中<span style="">event-user历史交互信息</span>，再利用scipy.spatial.distance.correlation计算uniqueEventPairs中每两个event(这两个event至少被同一个user产生过行为)相似度，类似于协同过滤中相似度计算。（利用历史行为数据）&nbsp;<br style="">
④eventContSim :dok_matrix形式，shape[len(events),len(events)]，根据event本身所包含的信息计算uniqueEventPairs中每两个event(这两个event至少被同一个user产生过行为)相似度。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs ruby has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">Events</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">""</span><span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"
  构建event-event相似度，注意这里有2种相似度：
  1）由用户-event行为，类似协同过滤算出的相似度
  2）由event本身的内容(event信息)计算出的event-event相似度
  "</span><span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">""</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> </span>__init_<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">_</span>(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>, programEntities, psim=ssd.correlation, csim=ssd.cosine)<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
    cleaner = <span class="hljs-constant" style="box-sizing: border-box;">DataCleaner</span>()
    fin = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"events.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
    fin.readline() <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># skip header</span>
    nevents = len(programEntities.eventIndex.keys())
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix = ss.dok_matrix((nevents, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">7</span>))
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix = ss.dok_matrix((nevents, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">100</span>))
    ln = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> fin.readlines()<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">#      if ln &gt; 10:</span>
<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">#        break</span>
      cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      eventId = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> programEntities.eventIndex.has_key(eventId)<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
        i = programEntities.eventIndex[eventId]
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] = cleaner.getJoinedYearMonth(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># start_time</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] = cleaner.getFeatureHash(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">3</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># city</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>] = cleaner.getFeatureHash(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># state</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">3</span>] = cleaner.getFeatureHash(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">5</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># zip</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>] = cleaner.getFeatureHash(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">6</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># country</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">5</span>] = cleaner.getFloatValue(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">7</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># lat</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">6</span>] = cleaner.getFloatValue(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">8</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># lon</span>
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> j <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> range(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">9</span>, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">109</span>)<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
          <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix[i, j-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">9</span>] = cols[j]
        ln += <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
    fin.close()
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix = normalize(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix,
        norm=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l1"</span>, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, copy=<span class="hljs-constant" style="box-sizing: border-box;">False</span>)
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EV_eventPropMatrix"</span>, <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix = normalize(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix,
        norm=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l1"</span>, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, copy=<span class="hljs-constant" style="box-sizing: border-box;">False</span>)
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EV_eventContMatrix"</span>, <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix)
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># calculate similarity between event pairs based on the two matrices    </span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropSim = ss.dok_matrix((nevents, nevents))
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContSim = ss.dok_matrix((nevents, nevents))
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> e1, e2 <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> programEntities.<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">uniqueEventPairs:</span>
      i = programEntities.eventIndex[e1]
      j = programEntities.eventIndex[e2]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">not</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropSim.has_key((i,j))<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
        epsim = psim(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix.getrow(i).todense(),
          <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropMatrix.getrow(j).todense())
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropSim[i, j] = epsim
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropSim[j, i] = epsim
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">not</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContSim.has_key((i,j))<span class="hljs-symbol" style="color: rgb(0, 102, 102); box-sizing: border-box;">:</span>
        ecsim = csim(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix.getrow(i).todense(),
          <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContMatrix.getrow(j).todense())
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContSim[i, j] = epsim
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContSim[j, i] = epsim
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EV_eventPropSim"</span>, <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventPropSim)
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EV_eventContSim"</span>, <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">self</span>.eventContSim)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">40</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">41</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">42</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">43</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">44</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">45</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">46</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">47</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">48</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">49</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">50</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">51</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">52</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">53</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">54</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">55</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">56</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">6.活跃度/event热度 数据</span>&nbsp;<br style="">
eventPopularity :dok_matrix形式，shape[len(events),1)],将event表中yes列和no列数据作差作为其event活跃度。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">EventAttendees</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">()</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  统计某个活动，参加和不参加的人数，从而为活动活跃度做准备
  """</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">__init__</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, programEvents)</span>:</span>
    nevents = len(programEvents.eventIndex.keys())
    self.eventPopularity = ss.dok_matrix((nevents, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>))
    f = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"event_attendees.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
    f.readline() <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># skip header</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> f:
      cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      eventId = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> programEvents.eventIndex.has_key(eventId):
        i = programEvents.eventIndex[eventId]
        self.eventPopularity[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] = \
          len(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>].split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">" "</span>)) - len(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>].split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">" "</span>))
    f.close()
    self.eventPopularity = normalize(self.eventPopularity, norm=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l1"</span>,
      axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, copy=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">False</span>)
    sio.mmwrite(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EA_eventPopularity"</span>, self.eventPopularity)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">7.串起所有的数据处理和准备流程</span></p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">data_prepare</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">()</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  计算生成所有的数据，用矩阵或者其他形式存储方便后续提取特征和建模
  """</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第1步：统计user和event相关信息..."</span>
  pe = ProgramEntities()
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第1步完成...\n"</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第2步：计算用户相似度信息，并用矩阵形式存储..."</span>
  Users(pe)
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第2步完成...\n"</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第3步：计算用户社交关系信息，并存储..."</span>
  UserFriends(pe)
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第3步完成...\n"</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第4步：计算event相似度信息，并用矩阵形式存储..."</span>
  Events(pe)
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第4步完成...\n"</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第5步：计算event热度信息..."</span>
  EventAttendees(pe)
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"第5步完成...\n"</span>

<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 运行进行数据准备</span>
data_prepare()</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">8.构建特征（DataRewriter类）</span>&nbsp;<br style="">
将上述保存到本地一些统计数据读取出来。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> __future__ <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> division

<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> cPickle
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> numpy <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> np
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> scipy.io <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> sio

<span class="hljs-class" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">class</span> <span class="hljs-title" style="box-sizing: border-box; color: rgb(102, 0, 102);">DataRewriter</span>:</span>
  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">__init__</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self)</span>:</span>
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 读入数据做初始化</span>
    self.userIndex = cPickle.load(open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"PE_userIndex.pkl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>))
    self.eventIndex = cPickle.load(open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"PE_eventIndex.pkl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>))
    self.userEventScores = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"PE_userEventScores"</span>).todense()
    self.userSimMatrix = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"US_userSimMatrix"</span>).todense()
    self.eventPropSim = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EV_eventPropSim"</span>).todense()
    self.eventContSim = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EV_eventContSim"</span>).todense()
    self.numFriends = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"UF_numFriends"</span>)
    self.userFriends = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"UF_userFriends"</span>).todense()
    self.eventPopularity = sio.mmread(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"EA_eventPopularity"</span>).todense()</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">基于用户协同过滤推荐结果作为特征</span>，我们以计算给用户i对活动j感兴趣程度为例，userSimMatrix[i, :]表示用户i与所有用户的相似度，userEventScores[：,j]表示所有用户对活动j的感兴趣程度。以上两矩阵相乘表示基于其他用户对活动j的感兴趣程度上计算用户i对活动j的感兴趣程度，这就是基于用户协同过滤推荐。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">userReco</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, userId, eventId)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    根据User-based协同过滤，得到event的推荐度
    基本的伪代码思路如下：
    for item i
      for every other user v that has a preference for i
        compute similarity s between u and v
        incorporate v's preference for i weighted by s into running aversge
    return top items ranked by weighted average
    """</span>
    i = self.userIndex[userId]
    j = self.eventIndex[eventId]
    vs = self.userEventScores[:, j]
    sims = self.userSimMatrix[i, :]
    prod = sims * vs
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">try</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> prod[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] - self.userEventScores[i, j]
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">except</span> IndexError:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span></code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">基于event协同过滤推荐结果作为特征</span>，这里event相似度有两种，一个是基于user-event历史交互信息得出的相似度，一种是基于event本身的内容信息得出的相似度。同上面类似的计算出推荐信息作为特征。</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">eventReco</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, userId, eventId)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    根据基于物品的协同过滤，得到Event的推荐度
    基本的伪代码思路如下：
    for item i 
      for every item j tht u has a preference for
        compute similarity s between i and j
        add u's preference for j weighted by s to a running average
    return top items, ranked by weighted average
    """</span>
    i = self.userIndex[userId]
    j = self.eventIndex[eventId]
    js = self.userEventScores[i, :]
    psim = self.eventPropSim[:, j]
    csim = self.eventContSim[:, j]
    pprod = js * psim
    cprod = js * csim
    pscore = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    cscore = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">try</span>:
      pscore = pprod[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] - self.userEventScores[i, j]
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">except</span> IndexError:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">pass</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">try</span>:
      cscore = cprod[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] - self.userEventScores[i, j]
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">except</span> IndexError:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">pass</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> pscore, cscore</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">统计返回各个user的朋友个数</span></p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">userPop</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, userId)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    基于用户的朋友个数来推断用户的社交程度
    主要的考量是如果用户的朋友非常多，可能会更倾向于参加各种社交活动
    """</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> self.userIndex.has_key(userId):
      i = self.userIndex[userId]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">try</span>:
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> self.numFriends[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, i]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">except</span> IndexError:
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">else</span>:
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span></code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">朋友对用户的影响</span></p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;">  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">friendInfluence</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, userId)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    朋友对用户的影响
    主要考虑用户所有的朋友中，有多少是非常喜欢参加各种社交活动/event的
    用户的朋友圈如果都积极参与各种event，可能会对当前用户有一定的影响
    userFriends:dok_matrix,shape[len(users),len(users)],统计第i个user的第j个朋友的活跃程度。
    """</span>
    nusers = np.shape(self.userFriends)[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]
    i = self.userIndex[userId]
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> (self.userFriends[i, :].sum(axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>) / nusers)[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>,<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">活动热度</span></p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">eventPop</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, eventId)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    本活动本身的热度
    主要是通过参与的人数来界定的
    """</span>
    i = self.eventIndex[eventId]
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> self.eventPopularity[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">生成训练集特征，测试集特征</span>&nbsp;<br style="">
生成以下特征：&nbsp;<br style="">
①：train中invited特征&nbsp;<br style="">
②：基于用户的推荐结果信息&nbsp;<br style="">
③：基于event的推荐结果信息&nbsp;<br style="">
④：用户活跃程度（根据朋友数量）&nbsp;<br style="">
⑤：用户受朋友影响程度&nbsp;<br style="">
⑥：活动的流行程度&nbsp;<br style="">
如果是train：&nbsp;<br style="">
⑦：interest&nbsp;<br style="">
⑧：not interest</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">rewriteData</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self, start=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>, train=True, header=True)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    把前面user-based协同过滤 和 item-based协同过滤，以及各种热度和影响度作为特征组合在一起
    生成新的训练数据，用于分类器分类使用
    """</span>
    fn = <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"train.csv"</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> train <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">else</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"test.csv"</span>
    fin = open(fn, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'rb'</span>)
    fout = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"data_"</span> + fn, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'wb'</span>)
    <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># write output header</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> header:
      ocolnames = [<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"invited"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_p_reco"</span>,
        <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_c_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_pop"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"frnd_infl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_pop"</span>]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> train:
        ocolnames.append(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"interested"</span>)
        ocolnames.append(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"not_interested"</span>)
      fout.write(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>.join(ocolnames) + <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"\n"</span>)
    ln = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> line <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> fin:
      ln += <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> ln &lt; start:
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">continue</span>
      cols = line.strip().split(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>)
      userId = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>]
      eventId = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]
      invited = cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> ln%<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">500</span> == <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>:
          <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"%s:%d (userId, eventId)=(%s, %s)"</span> % (fn, ln, userId, eventId)
      user_reco = self.userReco(userId, eventId)
      evt_p_reco, evt_c_reco = self.eventReco(userId, eventId)
      user_pop = self.userPop(userId)
      frnd_infl = self.friendInfluence(userId)
      evt_pop = self.eventPop(eventId)
      ocols = [invited, user_reco, evt_p_reco,
        evt_c_reco, user_pop, frnd_infl, evt_pop]
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> train:
        ocols.append(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">4</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># interested</span>
        ocols.append(cols[<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">5</span>]) <span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># not_interested</span>
      fout.write(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>.join(map(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">lambda</span> x: str(x), ocols)) + <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"\n"</span>)
    fin.close()
    fout.close()

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">rewriteTrainingSet</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self)</span>:</span>
    self.rewriteData(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>)

  <span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">rewriteTestSet</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(self)</span>:</span>
    self.rewriteData(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">False</span>)

<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># When running with cython, the actual class will be converted to a .so</span>
<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># file, and the following code (along with the commented out import below)</span>
<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># will need to be put into another .py and this should be run.</span>

<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;">#import CRegressionData as rd</span>

dr = DataRewriter()
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"生成训练数据...\n"</span>
dr.rewriteData(train=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>, start=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>, header=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>)
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"生成预测数据...\n"</span>
dr.rewriteData(train=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">False</span>, start=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>, header=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">40</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">41</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">42</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">43</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">44</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">45</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">46</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">47</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">48</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">49</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">50</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">51</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">52</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">53</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">54</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">55</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">56</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">57</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">58</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">9.建模与预测</span>&nbsp;<br style="">
实际上在上述特征构造好了之后，我们有很多的办法去训练得到模型和完成预测，这里用了sklearn中的SGDClassifier 事实上xgboost有更好的效果（显然我们的特征大多是密集型的浮点数，很适合GBDT这样的模型）&nbsp;<br style="">
注意交叉验证，我们这里用了10折的交叉验证</p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
用训练集特征训练模型</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 建模与预测</span>
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> __future__ <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> division

<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> math

<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> numpy <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> np
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> pandas <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> pd

<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> sklearn.cross_validation <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> KFold
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> sklearn.linear_model <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> SGDClassifier

<span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">train</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">()</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  在我们得到的特征上训练分类器，target为1(感兴趣)，或者是0(不感兴趣)
  """</span>
  trainDf = pd.read_csv(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"data_train.csv"</span>)
  trainDf.fillna(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>,inplace=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>)
  X = np.matrix(pd.DataFrame(trainDf, index=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">None</span>,
    columns=[<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"invited"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_p_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_c_reco"</span>,
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_pop"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"frnd_infl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_pop"</span>]))
  y = np.array(trainDf.interested)
  clf = SGDClassifier(loss=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"log"</span>, penalty=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l2"</span>)
  clf.fit(X, y)
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> clf

</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li></ul></pre><pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">validate</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">()</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  10折的交叉验证，并输出交叉验证的平均准确率
  """</span>
  trainDf = pd.read_csv(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"data_train.csv"</span>)
  trainDf.fillna(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>,inplace=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>)
  X = np.matrix(pd.DataFrame(trainDf, index=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">None</span>,
    columns=[<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"invited"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_p_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_c_reco"</span>,
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_pop"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"frnd_infl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_pop"</span>]))
  y = np.array(trainDf.interested)
  kfold = KFold(n_splits=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">10</span>)
  avgAccuracy = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
  run = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> train, test <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> kfold.split(X):
    Xtrain, Xtest, ytrain, ytest = X[train], X[test], y[train], y[test]
    clf = SGDClassifier(loss=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"log"</span>, penalty=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"l2"</span>)
    clf.fit(Xtrain, ytrain)
    accuracy = <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>
    ntest = len(ytest)
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> range(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, ntest):
      yt = clf.predict(Xtest[i, :])
      <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> yt == ytest[i]:
        accuracy += <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
    accuracy = accuracy / ntest
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"accuracy (run %d): %f"</span> % (run, accuracy)
    avgAccuracy += accuracy
    run += <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">print</span> <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"Average accuracy"</span>, (avgAccuracy / run)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<img src="https://img-blog.csdn.net/20170625214241504?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:602px; max-height:100%; height:auto"></p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
我们再用学习曲线看看是否过拟合还是前拟合</p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> numpy <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> np
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> matplotlib.pyplot <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">as</span> plt
<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">from</span> sklearn.learning_curve <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">import</span> learning_curve

<span class="hljs-comment" style="color: rgb(136, 0, 0); box-sizing: border-box;"># 用sklearn的learning_curve得到training_score和cv_score，使用matplotlib画出learning curve</span>
<span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">plot_learning_curve</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(estimator, title, X, y, ylim=None, cv=None, n_jobs=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>, 
                        train_sizes=np.linspace<span class="hljs-params" style="box-sizing: border-box;">(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">.05</span>, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1.</span>, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">20</span>)</span>, verbose=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, plot=True)</span>:</span>
    <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
    画出data在某模型上的learning curve.
    参数解释
    ----------
    estimator : 你用的分类器。
    title : 表格的标题。
    X : 输入的feature，numpy类型
    y : 输入的target vector
    ylim : tuple格式的(ymin, ymax), 设定图像中纵坐标的最低点和最高点
    cv : 做cross-validation的时候，数据分成的份数，其中一份作为cv集，其余n-1份作为training(默认为3份)
    n_jobs : 并行的的任务数(默认1)
    """</span>
    train_sizes, train_scores, test_scores = learning_curve(
        estimator, X, y, cv=cv, n_jobs=n_jobs, train_sizes=train_sizes, verbose=verbose)

    train_scores_mean = np.mean(train_scores, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>)
    train_scores_std = np.std(train_scores, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>)
    test_scores_mean = np.mean(test_scores, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>)
    test_scores_std = np.std(test_scores, axis=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>)

    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> plot:
        plt.figure()
        plt.title(title)
        <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">if</span> ylim <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">is</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">not</span> <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">None</span>:
            plt.ylim(*ylim)
        plt.xlabel(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">u"训练样本数"</span>)
        plt.ylabel(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">u"得分"</span>)
        plt.gca().invert_yaxis()
        plt.grid()

        plt.fill_between(train_sizes, train_scores_mean - train_scores_std, train_scores_mean + train_scores_std, 
                         alpha=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0.1</span>, color=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"b"</span>)
        plt.fill_between(train_sizes, test_scores_mean - test_scores_std, test_scores_mean + test_scores_std, 
                         alpha=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0.1</span>, color=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"r"</span>)
        plt.plot(train_sizes, train_scores_mean, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'o-'</span>, color=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"b"</span>, label=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">u"训练集上得分"</span>)
        plt.plot(train_sizes, test_scores_mean, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'o-'</span>, color=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"r"</span>, label=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">u"交叉验证集上得分"</span>)

        plt.legend(loc=<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"best"</span>)

        plt.draw()
        plt.gca().invert_yaxis()
        plt.show()

    midpoint = ((train_scores_mean[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] + train_scores_std[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]) + (test_scores_mean[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] - test_scores_std[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>])) / <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>
    diff = (train_scores_mean[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] + train_scores_std[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]) - (test_scores_mean[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] - test_scores_std[-<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>])
    <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">return</span> midpoint, diff
trainDf = pd.read_csv(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"data_train.csv"</span>)
trainDf.fillna(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>,inplace=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">True</span>)
X = np.matrix(pd.DataFrame(trainDf, index=<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">None</span>,columns=[<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"invited"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_p_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_c_reco"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user_pop"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"frnd_infl"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"evt_pop"</span>]))
y = np.array(trainDf.interested)
plot_learning_curve(clf, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">u"学习曲线"</span>, X, y,cv=<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">10</span>)</code><ul class="pre-numbering" style="box-sizing: border-box; line-height: 23.8px; margin: 0px; position: absolute; width: 50px; background-color: rgb(238, 238, 238); top: 0px; left: 0px; padding: 6px 0px 40px; border-right: 1px solid rgb(221, 221, 221); list-style: none; text-align: right;"><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">1</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">2</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">3</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">4</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">5</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">6</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">7</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">8</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">9</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">10</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">11</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">12</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">13</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">14</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">15</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">16</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">17</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">18</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">19</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">20</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">21</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">22</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">23</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">24</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">25</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">26</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">27</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">28</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">29</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">30</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">31</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">32</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">33</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">34</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">35</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">36</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">37</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">38</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">39</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">40</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">41</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">42</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">43</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">44</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">45</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">46</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">47</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">48</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">49</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">50</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">51</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">52</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">53</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">54</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">55</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">56</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">57</li><li style="box-sizing: border-box; padding: 0px 5px; list-style: none; margin-left: 0px;">58</li></ul></pre>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<img src="https://img-blog.csdn.net/20170625214519001?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvTXJfdHl0aW5n/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述" title="" style="border:none; margin-top:15px; margin-bottom:15px; max-width:602px; max-height:100%; height:auto"></p>
<p style="margin-top:0px; margin-bottom:1.7em; padding-top:0px; padding-bottom:0px; line-height:27.2px; color:rgb(63,63,63); font-family:&quot;microsoft yahei&quot;; font-size:16px">
<span style="">对test数据进行预测</span></p>
<pre class="prettyprint" name="code" style="white-space: nowrap; word-wrap: break-word; box-sizing: border-box; position: relative; overflow-y: hidden; overflow-x: auto; margin-top: 0px; margin-bottom: 1.7em; line-height: 23.8px; font-family: &quot;Source Code Pro&quot;, monospace; padding: 5px 5px 5px 60px; font-size: 14px; word-break: break-all; color: rgb(51, 51, 51); background-color: rgba(128, 128, 128, 0.05); border: 0px solid rgb(136, 136, 136); border-radius: 0px;"><code class="hljs python has-numbering" style="display: block; padding: 0px; background: transparent; color: inherit; box-sizing: border-box; font-family: &quot;Source Code Pro&quot;, monospace; font-size: 12.6px; white-space: pre; border-radius: 0px; overflow-x: auto; word-wrap: normal;"><span class="hljs-function" style="box-sizing: border-box;"><span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">def</span> <span class="hljs-title" style="box-sizing: border-box;">test</span><span class="hljs-params" style="color: rgb(102, 0, 102); box-sizing: border-box;">(clf)</span>:</span>
  <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"""
  读取test数据，用分类器完成预测
  """</span>
  origTestDf = pd.read_csv(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"test.csv"</span>)
  users = origTestDf.user
  events = origTestDf.event
  testDf = pd.read_csv(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"data_test.csv"</span>)
  fout = open(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"result.csv"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">'wb'</span>)
  fout.write(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>.join([<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"user"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"event"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"outcome"</span>, <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"dist"</span>]) + <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"\n"</span>)
  nrows = len(testDf)
  Xp = np.matrix(testDf)
  yp = np.zeros((nrows, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">2</span>))
  <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">for</span> i <span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">in</span> range(<span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>, nrows):
    xp = Xp[i, :]
    yp[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>] = clf.predict(xp)
    yp[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>] = clf.decision_function(xp)
    fout.write(<span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">","</span>.join(map(<span class="hljs-keyword" style="color: rgb(0, 0, 136); box-sizing: border-box;">lambda</span> x: str(x), 
      [users[i], events[i], yp[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">0</span>], yp[i, <span class="hljs-number" style="color: rgb(0, 102, 102); box-sizing: border-box;">1</span>]])) + <span class="hljs-string" style="color: rgb(0, 136, 0); box-sizing: border-box;">"\n"</span>)
  fout.close()</code></pre>
            </div>
                </div>
